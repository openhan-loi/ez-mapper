<!doctype html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>EzAdmin Smart Mapper</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Noto+Sans+KR:wght@300;400;700&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--primary: #6366f1;
				--secondary: #a855f7;
				--bg: #0f172a;
				--card: rgba(30, 41, 59, 0.7);
				--text: #f8fafc;
				--accent: #10b981;
			}

			body {
				background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
				color: var(--text);
				font-family: 'Outfit', 'Noto Sans KR', sans-serif;
				margin: 0;
				min-height: 100vh;
				display: flex;
				flex-direction: column;
				align-items: center;
				overflow-x: hidden;
			}

			.container {
				width: 90%;
				max-width: 1000px;
				margin-top: 50px;
				padding-bottom: 50px;
			}

			header {
				text-align: center;
				margin-bottom: 40px;
				animation: fadeInDown 0.8s ease-out;
			}

			h1 {
				font-size: 2.5rem;
				margin-bottom: 10px;
				background: linear-gradient(to right, #818cf8, #c084fc);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
			}

			.main-card {
				background: var(--card);
				backdrop-filter: blur(12px);
				border: 1px solid rgba(255, 255, 255, 0.1);
				border-radius: 24px;
				padding: 40px;
				box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
				animation: scaleIn 0.5s ease-out;
			}

			.task-info {
				background: rgba(99, 102, 241, 0.1);
				border-left: 4px solid var(--primary);
				padding: 24px;
				border-radius: 16px;
				margin-bottom: 30px;
			}

			.task-label {
				font-size: 0.85rem;
				color: #94a3b8;
				margin-bottom: 12px;
				letter-spacing: 0.5px;
				text-transform: uppercase;
			}

			.keyword-container {
				display: flex;
				flex-wrap: wrap;
				gap: 8px;
				margin-top: 10px;
			}

			.keyword-tag {
				background: rgba(255, 255, 255, 0.08);
				border: 1px solid rgba(255, 255, 255, 0.15);
				padding: 6px 14px;
				border-radius: 30px;
				font-size: 0.95rem;
				cursor: pointer;
				transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
				user-select: none;
				display: inline-block;
			}

			.keyword-tag:hover {
				background: var(--primary);
				border-color: var(--primary);
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
			}

			.keyword-tag.active {
				background: var(--primary);
				border-color: var(--primary);
			}

			.search-section {
				display: flex;
				gap: 15px;
				margin-bottom: 20px;
			}

			input {
				flex: 1;
				background: rgba(15, 23, 42, 0.6);
				border: 1px solid rgba(255, 255, 255, 0.1);
				padding: 18px 25px;
				border-radius: 16px;
				color: white;
				font-size: 1.1rem;
				transition: all 0.3s;
			}

			input:focus {
				outline: none;
				border-color: var(--primary);
				box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
			}

			button {
				padding: 12px 28px;
				border-radius: 16px;
				border: none;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s;
				font-family: inherit;
			}

			.btn-primary {
				background: linear-gradient(135deg, var(--primary), var(--secondary));
				color: white;
			}
			.btn-primary:hover {
				transform: translateY(-2px);
				box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
			}

			.btn-repeat {
				background: rgba(168, 85, 247, 0.15);
				color: #d8b4fe;
				border: 1px solid rgba(168, 85, 247, 0.25);
			}
			.btn-repeat:hover {
				background: rgba(168, 85, 247, 0.25);
			}

			.results-container {
				max-height: 450px;
				overflow-y: auto;
				margin-top: 25px;
				border-radius: 16px;
				padding-right: 5px;
			}

			.results-container::-webkit-scrollbar {
				width: 6px;
			}
			.results-container::-webkit-scrollbar-thumb {
				background: rgba(255, 255, 255, 0.1);
				border-radius: 10px;
			}

			.result-item {
				background: rgba(255, 255, 255, 0.03);
				padding: 18px 24px;
				margin-bottom: 12px;
				border-radius: 16px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				border: 1px solid transparent;
				cursor: pointer;
				transition: all 0.25s;
			}

			.result-item:hover {
				background: rgba(255, 255, 255, 0.07);
				border-color: var(--primary);
				transform: translateX(8px);
			}

			.res-code {
				font-family: 'Outfit', monospace;
				color: #818cf8;
				font-weight: bold;
				font-size: 0.95rem;
				background: rgba(99, 102, 241, 0.1);
				padding: 4px 10px;
				border-radius: 8px;
			}
			.res-details {
				flex: 1;
				margin: 0 20px;
			}
			.res-name {
				font-weight: 600;
				font-size: 1.05rem;
				display: block;
				margin-bottom: 4px;
			}
			.res-option {
				color: #94a3b8;
				font-size: 0.9rem;
			}

			@keyframes fadeInDown {
				from {
					opacity: 0;
					transform: translateY(-20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			@keyframes scaleIn {
				from {
					opacity: 0;
					transform: scale(0.95);
				}
				to {
					opacity: 1;
					transform: scale(1);
				}
			}

			.progress-bar {
				width: 100%;
				height: 8px;
				background: rgba(255, 255, 255, 0.05);
				border-radius: 20px;
				margin-bottom: 25px;
				overflow: hidden;
			}

			.progress-fill {
				height: 100%;
				background: linear-gradient(to right, #6366f1, #a855f7, #ec4899);
				width: 0%;
				transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
			}
		</style>
	</head>
	<body>
		<div class="container" id="app">
			<header>
				<h1>EzAdmin Smart Mapper</h1>
				<div id="stats" style="color: #64748b; font-size: 0.95rem">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
			</header>

			<div class="progress-bar">
				<div id="progress" class="progress-fill"></div>
			</div>

			<div class="main-card">
				<div class="task-info">
					<div class="task-label">í˜„ì¬ ë§¤í•‘ ëŒ€ìƒ (í‚¤ì›Œë“œë¥¼ í´ë¦­í•˜ì—¬ ê²€ìƒ‰ì–´ ì¡°í•© ê°€ëŠ¥)</div>
					<div class="keyword-container" id="keyword-box">
						<!-- Dynamic Keywords -->
					</div>
				</div>

				<div class="search-section">
					<input type="text" id="searchInput" placeholder="í‚¤ì›Œë“œ í´ë¦­ ë˜ëŠ” ì§ì ‘ ì…ë ¥..." />
					<button class="btn-primary" onclick="search()">ê²€ìƒ‰</button>
					<button
						class="btn-repeat"
						onclick="repeatLast()"
						title="ë§ˆì§€ë§‰ìœ¼ë¡œ ì„ íƒí•œ ìƒí’ˆì½”ë“œë¥¼ í˜„ì¬ ìƒí’ˆì— ì¦‰ì‹œ ì ìš©"
					>
						ì§ì „ ê°’ ì ìš©
					</button>
				</div>

				<div id="results" class="results-container">
					<!-- Results go here -->
				</div>
			</div>
		</div>

		<script>
			let tasks = [];
			let lastMappedCode = null;
			let totalTasks = 0;

			async function init() {
				const res = await fetch('/api/get_tasks');
				tasks = await res.json();
				totalTasks = tasks.length;
				updateUI();
			}

			function tokenize(name, option) {
				// Split by common separators to create clickable tags
				const raw = `${name} ${option.replace('/', ' ')}`;
				const tokens = raw.split(/[-_\s,]+/).filter((t) => t.length > 0 && t !== 'nan');
				return [...new Set(tokens)]; // Unique tokens
			}

			function updateUI() {
				if (tasks.length === 0) {
					document.getElementById('keyword-box').innerHTML =
						"<div class='task-value'>ğŸ‰ ëª¨ë“  ë§¤í•‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>";
					document.getElementById('stats').innerText = 'Clear!';
					document.getElementById('progress').style.width = '100%';
					document.getElementById('searchInput').disabled = true;
					return;
				}

				const current = tasks[0];
				const tokens = tokenize(current.name, current.option);

				const keywordBox = document.getElementById('keyword-box');
				keywordBox.innerHTML = '';
				tokens.forEach((token) => {
					const tag = document.createElement('span');
					tag.className = 'keyword-tag';
					tag.innerText = token;
					tag.onclick = () => addKeyword(token);
					keywordBox.appendChild(tag);
				});

				document.getElementById('stats').innerText = `ë‚¨ì€ ì‘ì—…: ${tasks.length}ê°œ`;

				// Clear search for new item
				document.getElementById('searchInput').value = '';

				// Progress
				const prog = totalTasks > 0 ? ((totalTasks - tasks.length) / totalTasks) * 100 : 100;
				document.getElementById('progress').style.width = `${prog}%`;
			}

			function addKeyword(token) {
				const input = document.getElementById('searchInput');
				let currentVal = input.value.trim();

				// Prevent duplicate tokens in search box
				const existingTokens = currentVal.split(/\s+/);
				if (!existingTokens.includes(token)) {
					input.value = currentVal ? `${currentVal} ${token}` : token;
				}

				// Auto search on click for convenience
				search();
			}

			async function search() {
				const q = document.getElementById('searchInput').value;
				if (!q) return;

				const res = await fetch('/api/search_stock', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ query: q }),
				});
				const data = await res.json();

				const container = document.getElementById('results');
				container.innerHTML = '';

				if (data.length === 0) {
					container.innerHTML =
						'<div style="text-align: center; color: #64748b; padding: 40px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
					return;
				}

				data.forEach((item) => {
					const div = document.createElement('div');
					div.className = 'result-item';
					div.innerHTML = `
                    <div class="res-details">
                        <span class="res-name">${item.name}</span>
                        <span class="res-option">${item.option}</span>
                    </div>
                    <div class="res-code">${item.code}</div>
                `;
					div.onclick = () => save(item.code);
					container.appendChild(div);
				});
			}

			async function save(code) {
				const current = tasks[0];
				await fetch('/api/save_mapping', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ pk_key: current.pk_key, ez_code: code }),
				});

				lastMappedCode = code;
				tasks.shift();

				// Flash success effect?
				document.querySelector('.main-card').style.borderColor = 'var(--accent)';
				setTimeout(() => {
					document.querySelector('.main-card').style.borderColor = 'rgba(255,255,255,0.1)';
				}, 300);

				updateUI();
				document.getElementById('results').innerHTML = '';
			}

			function repeatLast() {
				if (lastMappedCode) {
					save(lastMappedCode);
				} else {
					alert('ì´ì „ì— ë§¤í•‘í•œ ê°’ì´ ì—†ìŠµë‹ˆë‹¤.');
				}
			}

			document.getElementById('searchInput').onkeypress = (e) => {
				if (e.key === 'Enter') search();
			};

			init();
		</script>
	</body>
</html>
